<!DOCTYPE html>
<html lang="en">

<head>
    <title>ConsultaCep</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <!-- import google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300&display=swap" rel="stylesheet">
    <!-- import icons -->
    <!-- <script src="https://kit.fontawesome.com/30c4adbfaf.js" crossorigin="anonymous"></script> -->
    <link rel="shortcut icon" href="~/favicon.ico">
    <!-- import css's -->
    <link rel="stylesheet" href="./css/styles.min.css">
    <link rel="stylesheet" href="./css/depsFontAwesome.min.css">
    <script src="./JavaScript/depsFontAwesome.min.js"></script>
    <script src="./JavaScript/depsJquery.min.js"></script>
    <script src="./JavaScript/depsJqueryMask.min.js"></script>
    <!-- other imports -->
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <script src="node_modules/jquery-mask-plugin/src/jquery.mask.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
</head>

<body>
    <nav>
        <div class=" Flex Flex-Center boxNav">
            <img src="images/CEP-logo.png">
        </div>
    </nav>
    <div class="Flex Flex-Column Flex-Center box-All">
        <div box-Form class="Flex Flex-Center">
            <form Form-ConsultaCep>
                <div class="Flex Flex-Column Flex-Center">
                    <i Icon-Localizacao class="fas fa-map-marker-alt fa-7x testeicon"></i>
                    <div box-Input-Button class="Flex Flex-Row">
                        <div class="Flex Flex-Column">
                            <input id="txtCep" placeholder="Insira o CEP">
                            <label id="errorCep">*Não foi possivel consultar informações!*</label>
                        </div>
                        <button id="btnConsultarCep" class="button" type="submit" value="Consultar"> Consultar
                            <i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="boxTable" class="boxTable Flex Flex-Center Flex-Column">
        <div class="boxTituloInfos Flex Flex-Center">
            <h1 class="Quicksand">
                INFORMAÇÕES
            </h1>
        </div>
        <table id="tableCepInfos" class="table">
        </table>
    </div>
    <div id="boxMap" class="boxMap">
    </div>
    <footer id='footer' class="Flex Flex-Row Flex-Center">
        <a><i icon-margin class="fab fa-github fa-6x"></i></a>
        <a><i class="fab fa-instagram fa-6x"></i></a>
    </footer>
</body>
<script>
    $(document).ready(function () {
        $('#txtCep').mask("00000-000");
    })

    $('#btnConsultarCep').on('click', (e) => {
        e.preventDefault();
        disableButtonTemporarily();
        clearElement('tableCepInfos');
        clearElement('boxMap');
        hideElement('boxTable');
        hideElement('boxMap');
        resetFooterDefinitions();
        ajaxConsultarCep();
    })
    function ajaxConsultarCep() {
        const inputValue = getValueInputAndRemoveHyphen('#txtCep');
        $.ajax({
            url: '/ConsultarCep',
            data: {
                cep: inputValue
            },
            method: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.erro) {
                    showElement('errorCep');
                }
                else {
                    hideElement('errorCep');
                    showElement('boxTable');
                    showElement('boxMap');
                    setFooterRlativePosition()
                    setElementDisplayFlex('boxTable');
                    fillTableOfCep(response)
                    loadMap(response.logradouro, response.localidade)
                }
            },
            error: function (response) {
                showElement('errorCep');
            }
        })
    }
    function getValueInputAndRemoveHyphen(inputId) {
        return $(inputId).val().replace('-', '')
    }
    function setFooterRlativePosition() {
        document.getElementById("footer").style.position = 'relative';
    }
    function showElement(idElement) {
        $(`#${idElement}`).show();
    }
    function hideElement(idElement) {
        $(`#${idElement}`).hide();
    }
    function clearElement(idElement) {
        $(`#${idElement}`).html('');
    }
    function setElementDisplayFlex(idElement) {
        $(`#${idElement}`).css('display', 'flex');
    }
    function resetFooterDefinitions() {
        $('footer').css('position', 'absolute');
        $('footer').css('top', '100%')
    }
    function fillTableOfCep(response) {
        $.each(response, (key, item) => { $('#tableCepInfos').append(getTrTextHtml(key, item)) })
    }
    function getTrTextHtml(key, item) {
        return `<tr>
                    <td class="tdStyle">
                        <label class="labelTable">${key.toString().toUpperCase()}</label>
                    </td>
                    <td class="tdStyle">
                        <label class="labelTable">${item}</label>    
                    </td>
                </tr>`
    }
    function disableButtonTemporarily() {
        $('#btnConsultarCep').attr('disabled', 'true');
        setTimeout(() => {
            $('#btnConsultarCep').removeAttr('disabled');
            console.log('5seg')
        }, 5000);
    }
    function loadMap(logradouro, cidade) {
        var platform = new H.service.Platform({
            'apikey': 'aE2IlRuV5Kh_h2WFoMJ9D2BxS_i4BjgJJvm81ELmX5o'
        });

        // Get default map types from the platform object:
        var defaultLayers = platform.createDefaultLayers();

        // Instantiate (and display) a map object:
        var map = new H.Map(
            document.getElementById('boxMap'),
            defaultLayers.vector.normal.map,
            {
                zoom: 18,
                center: { lat: 52.5, lng: 13.4 }
            });

        // Create the parameters for the geocoding request:
        var geocodingParams = {
            searchText: `${logradouro}, ${cidade}, Brazil`
        };

        // Define a callback function to process the geocoding response:
        var onResult = function (result) {
            var locations = result.Response.View[0].Result,
                position,
                marker;
            // Add a marker for each location found
            for (i = 0; i < locations.length; i++) {
                position = {
                    lat: locations[i].Location.DisplayPosition.Latitude,
                    lng: locations[i].Location.DisplayPosition.Longitude
                };
                map.setCenter(position);
                marker = new H.map.Marker(position);
                map.addObject(marker);
            }
        };

        // Get an instance of the geocoding service:
        var geocoder = platform.getGeocodingService();

        // Call the geocode method with the geocoding parameters,
        // the callback and an error callback function (called if a
        // communication error occurs):
        geocoder.geocode(geocodingParams, onResult, function (e) {
            alert(e);
        });

        // Create the default UI:
        var ui = H.ui.UI.createDefault(map, defaultLayers, 'pt-BR');

    }
</script>

</html>